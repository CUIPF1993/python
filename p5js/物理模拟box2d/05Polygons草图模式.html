<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Title</title>

    <script language="javascript" type="text/javascript" src="../libraries/p5.js"></script>
    <script language="javascript" type="text/javascript" src="../libraries/p5.dom.js"></script>
    <script language="javascript" type="text/javascript" src="../libraries/box2d-html5.js"></script>
    <script language="javascript" type="text/javascript" src="../libraries/box2d-helper.js"></script>
    <script language="javascript" type="text/javascript" src="../libraries/p5.collide2d.js"></script>
    <script language="javascript" type="text/javascript" src="../libraries/p5.scribble.js"></script>
</head>
<body>

<script>

    //定义一个box
    class Boundary {
        constructor(x, y, w, h) {
            this.x = x;
            this.y = y;
            this.w = w;
            this.h = h;

            //定义fixture
            let fd = new box2d.b2FixtureDef();
            fd.shape = new box2d.b2PolygonShape();
            fd.shape.SetAsBox(scaleToWorld(this.w / 2), scaleToWorld(this.h / 2));

            //设置物理属性
            fd.density = 1.0;
            fd.friction = 0.1;
            fd.restitution = 0.5;

            let bd = new box2d.b2BodyDef();
            bd.position = scaleToWorld(this.x, this.y);
            bd.type = box2d.b2BodyType.b2_staticBody;
            this.body = world.CreateBody(bd);
            this.body.CreateFixture(fd);
        }

        display() {
            // fill(127);
            stroke(255);
            strokeWeight(2);


            let xCoords = [this.x - this.w / 2, this.x + this.w / 2, this.x + this.w / 2, this.x - this.w / 2];
            let yCoords = [this.y - this.h / 2, this.y - this.h / 2, this.y + this.h / 2, this.y + this.h / 2];
            scribble.scribbleFilling(xCoords, yCoords, 3.5, 315);
            // fill(255);
            rectMode(CENTER);
            // rect(this.x, this.y, this.w, this.h);
            scribble.scribbleRect(this.x, this.y, this.w, this.h);

        }
    }


    //定义一个星形多边形
    class CustomShape {
        constructor(x, y) {

            //定义一个body
            let bd = new box2d.b2BodyDef();
            bd.type = box2d.b2BodyType.b2_dynamicBody;
            bd.position = scaleToWorld(x, y);

            //定义一个fixture
            let fd = new box2d.b2FixtureDef();

            let vertices = [];
            vertices[3] = scaleToWorld(-15, 25);
            vertices[2] = scaleToWorld(15, 0);
            vertices[1] = scaleToWorld(20, -15);
            vertices[0] = scaleToWorld(-10, -10);

            fd.shape = new box2d.b2PolygonShape();
            fd.shape.SetAsArray(vertices, vertices.length);

            //设置物理属性
            fd.density = 1.0;
            fd.friction = 0.05;
            fd.restitution = 0.1;

            this.body = world.CreateBody(bd);
            this.body.CreateFixture(fd);

            colorMode(HSB, 100);
            this.color = color(55, 65, random(30, 100));
        }

        killBody() {
            world.DestroyBody(this.body);
        }

        done() {
            let pos = scaleToWorld(this.body.GetPosition());

            if (pos.y > height + this.w * this.h) {
                this.killBody();
                return true;
            }
            return false;
        }

        //绘制customShape
        display() {
            let pos = scaleToPixels(this.body.GetPosition());
            let a = this.body.GetAngleRadians();

            let f = this.body.GetFixtureList();
            let ps = f.GetShape();

            rectMode(CENTER);
            push();
            translate(pos.x, pos.y);
            rotate(a);

            stroke(this.color);
            strokeWeight(2);

            // beginShape();
            // for (let i = 0; i < ps.m_count; i++) {
            //     let v = scaleToPixels(ps.m_vertices[i]);
            //     vertex(v.x, v.y);
            // }
            // endShape();

            let xCoords = [];
            let yCoords = [];

            for (let i = 0; i < ps.m_count; i++) {
                let v = scaleToPixels(ps.m_vertices[i]);
                xCoords.push(v.x);
                yCoords.push(v.y);
            }

            scribble.scribbleFilling(xCoords, yCoords, 3.5, 315);

            stroke(127);
            for (let i = 0; i < ps.m_count - 1; i++) {
                let v1 = scaleToPixels(ps.m_vertices[i]);
                let v2 = scaleToPixels(ps.m_vertices[i + 1]);
                scribble.scribbleLine(v1.x, v1.y, v2.x, v2.y);
            }
            let count = ps.m_count;
            let v1 = scaleToPixels(ps.m_vertices[count-1]);
            let v2 = scaleToPixels(ps.m_vertices[0]);
            scribble.scribbleLine(v1.x, v1.y, v2.x, v2.y);

            pop();
        }
    }

    /**/
    let world;
    let boundaries = [];
    let polygons = [];
    let scribble;

    function setup() {
        createCanvas(640, 360);

        world = createWorld();
        scribble = new Scribble();
        scribble.roughness = 1;

        scribble.numEllipseSteps = 1;
        scribble.bowing = 1;
        scribble.maxOffset = 0.5;


        boundaries.push(new Boundary(width / 4, height - 5, width / 2 - 50, 20, 0));
        boundaries.push(new Boundary(3 * width / 4, height - 50, width / 2 - 50, 20, 0));
        boundaries.push(new Boundary(width - 5, height / 2, 20, height, 0));
        boundaries.push(new Boundary(5, height / 2, 20, height, 0));
    }


    function draw() {
        background(51);

        let timeStep = 1.0 / 30;
        world.Step(timeStep, 10, 10);

        for (let i = 0; i < boundaries.length; i++) {
            boundaries[i].display();
        }

        for (let i = polygons.length - 1; i >= 0; i--) {
            polygons[i].display();
            if (polygons[i].done()) {
                polygons.slice(i, 1);
            }
        }

    }

    function mousePressed() {
        let cs = new CustomShape(mouseX, mouseY);
        polygons.push(cs)
    }


</script>

</body>
</html>